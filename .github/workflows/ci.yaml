# .github/workflows/ci.yml
name: CI
on:
  # Running CI on all commits on all branches (implicitly covers pull request too)
  push:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress:  ${{ github.ref_name != 'main' }}

jobs:
  ci:
    needs: [earthly, e2e, coverage, nix-build, nix-tests, windows-build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - shell: bash
        run: |
          [[ $(echo '${{ toJSON(needs) }}' | jq 'map(select(.result != "success")) | length == 0') == 'true' ]] || exit 1
  earthly:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: test
            privileged: true
          - target: test-miri
            privileged: false
          - target: test-cross-arm64
            privileged: true
          - target: test-cross-riscv64
            privileged: true
          - target: build
            privileged: false
          - target: build-cross-arm64
            privileged: false
          - target: build-cross-riscv64
            privileged: false
          - target: fmt
            privileged: false
          - target: lint
            privileged: false
          - target: check-dependencies
            privileged: false
    runs-on: ubuntu-latest
    env:
      FORCE_COLOR: 1
    steps:
      - uses: earthly/actions-setup@v1
        with:
          version: ~v0.8
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v4
      - name: Run +${{ matrix.target }} on Earthly
        run: earthly --ci --output ${{ matrix.privileged == true && '--allow-privileged' || '' }} +${{ matrix.target }}

      - name: Upload lightway-client artifact (x86_64)
        if: matrix.target == 'build'
        uses: actions/upload-artifact@v4
        with:
          name: lightway-client-x86_64-unknown-linux-gnu
          path: target/release/lightway-client

      - name: Upload lightway-server artifact (x86_64)
        if: matrix.target == 'build'
        uses: actions/upload-artifact@v4
        with:
          name: lightway-server-x86_64-unknown-linux-gnu
          path: target/release/lightway-server

      - name: Upload lightway-client artifact (arm64)
        if: matrix.target == 'build-cross-arm64'
        uses: actions/upload-artifact@v4
        with:
          name: lightway-client-aarch64-unknown-linux-gnu
          path: target/aarch64-unknown-linux-gnu/release/lightway-client

      - name: Upload lightway-server artifact (arm64)
        if: matrix.target == 'build-cross-arm64'
        uses: actions/upload-artifact@v4
        with:
          name: lightway-server-aarch64-unknown-linux-gnu
          path: target/aarch64-unknown-linux-gnu/release/lightway-server

      - name: Upload lightway-client artifact (riscv64)
        if: matrix.target == 'build-cross-riscv64'
        uses: actions/upload-artifact@v4
        with:
          name: lightway-client-riscv64gc-unknown-linux-gnu
          path: target/riscv64gc-unknown-linux-gnu/release/lightway-client

      - name: Upload lightway-server artifact (riscv64)
        if: matrix.target == 'build-cross-riscv64'
        uses: actions/upload-artifact@v4
        with:
          name: lightway-server-riscv64gc-unknown-linux-gnu
          path: target/riscv64gc-unknown-linux-gnu/release/lightway-server

  e2e:
    runs-on: ubuntu-latest
    env:
      FORCE_COLOR: 1
    strategy:
      fail-fast: false
      matrix:
        distro: [bookworm]
    steps:
      - uses: earthly/actions-setup@v1
        with:
          version: ~v0.8
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v4
      - name: Run +e2e on Earthly
        run: earthly --ci --allow-privileged +e2e --debian ${{ matrix.distro }}
  coverage:
    runs-on: ubuntu-latest
    env:
      FORCE_COLOR: 1
    steps:
      - uses: earthly/actions-setup@v1
        with:
          version: ~v0.8
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v4
      - name: Run +coverage on Earthly
        id: coverage
        run: |
          earthly --ci --allow-privileged --artifact +coverage/* output/

          cat output/summary.txt

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "summary<<$EOF"    >> "$GITHUB_OUTPUT"
          cat output/summary.txt  >> "$GITHUB_OUTPUT"
          echo ""                 >> "$GITHUB_OUTPUT"
          echo "$EOF"             >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: output/html
          if-no-files-found: error
      - name: Check coverage
        id: coverage-check
        run: |
          REGIONS_SOFT_THRESHOLD=50
          REGIONS_HARD_THRESHOLD=40
          LINES_SOFT_THRESHOLD=60
          LINES_HARD_THRESHOLD=50

          regions_coverage=$(jq '.data[].totals.regions.percent | floor' output/coverage.json)
          lines_coverage=$(jq '.data[].totals.lines.percent | floor' output/coverage.json)

          echo "Regions: $regions_coverage% (soft: $REGIONS_SOFT_THRESHOLD%, hard: $REGIONS_HARD_THRESHOLD%)"
          echo "Lines: $lines_coverage% (soft: $LINES_SOFT_THRESHOLD%, hard: $LINES_HARD_THRESHOLD%)"

          FAILED=false

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "text<<$EOF" >> "$GITHUB_OUTPUT"

          if [[ $regions_coverage -lt $REGIONS_HARD_THRESHOLD ]] ; then
              echo ":x: Region coverage $regions_coverage% below hard threshold $REGIONS_HARD_THRESHOLD%" >> "$GITHUB_OUTPUT"
              FAILED=true
          elif [[ $regions_coverage -lt $REGIONS_SOFT_THRESHOLD ]] ; then
              echo ":warning: Region coverage $regions_coverage% below soft threshold $REGIONS_SOFT_THRESHOLD%" >> "$GITHUB_OUTPUT"
          else
              echo ":white_check_mark: Region coverage $regions_coverage% passes" >> "$GITHUB_OUTPUT"
          fi

          if [[ $lines_coverage -lt $LINES_HARD_THRESHOLD ]] ; then
              echo ":x: Line coverage $lines_coverage% below hard threshold $LINES_HARD_THRESHOLD%" >> "$GITHUB_OUTPUT"
              FAILED=true
          elif [[ $lines_coverage -lt $LINES_SOFT_THRESHOLD ]] ; then
              echo ":warning: Line coverage $lines_coverage% below soft threshold $LINES_SOFT_THRESHOLD%" >> "$GITHUB_OUTPUT"
          else
              echo ":white_check_mark: Line coverage $lines_coverage% passes" >> "$GITHUB_OUTPUT"
          fi

          echo "$EOF" >> "$GITHUB_OUTPUT"

          echo "Setting output: failed: $FAILED"
          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"

      - uses: jwalton/gh-find-current-pr@v1
        id: find-pr
        with:
          state: open
      - name: Find Coverage Comment
        if: steps.find-pr.outputs.number
        uses: peter-evans/find-comment@v3
        id: coverage-comment
        with:
          issue-number: ${{ steps.find-pr.outputs.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Code coverage summary'
      - name: Create or update comment
        if: steps.find-pr.outputs.number
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.coverage-comment.outputs.comment-id }}
          issue-number: ${{ steps.find-pr.outputs.number }}
          body: |
            [Code coverage summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for ${{ github.sha }}:
            ```
            ${{ steps.coverage.outputs.summary }}
            ```
            ${{ steps.coverage-check.outputs.text }}
          edit-mode: replace
      - name: Coverage check fails
        if: steps.coverage-check.outputs.failed == 'true'
        run: exit 1

  nix-build:
    name: Nix Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-apple-darwin
            os: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13
        with:
          use-flakehub: false

      - run: mkdir -p build/

      - name: Build lightway client on MSRV version
        if: matrix.os == 'ubuntu-latest'
        run: nix build .#lightway-client-msrv

      - name: Build lightway server on MSRV version
        if: matrix.os == 'ubuntu-latest'
        run: nix build .#lightway-server-msrv

      - name: Build lightway client
        run: nix build .#lightway-client -o result-client

      - name: Build lightway server
        run: nix build .#lightway-server -o result-server

      - name: Upload lightway-client artifact
        if: matrix.os == 'macos-latest' || matrix.os == 'macos-15-intel'
        uses: actions/upload-artifact@v4
        with:
          name: lightway-client-${{ matrix.target }}
          path: result-client/bin/lightway-client

      - name: Upload lightway-server artifact
        if: matrix.os == 'macos-latest' || matrix.os == 'macos-15-intel'
        uses: actions/upload-artifact@v4
        with:
          name: lightway-server-${{ matrix.target }}
          path: result-server/bin/lightway-server

  nix-tests:
    name: Nix tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest, macos-15-intel]
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13
        with:
          use-flakehub: false

      - run: nix flake check

      - name: Run clippy
        run: nix develop --command cargo make clippy

      - name: Run cargo tests
        run: nix develop --command cargo test

      - name: Run cargo tests with kyber_only feature
        run: nix develop --command cargo test --features kyber_only

      - name: Run privileged tests (macOS only)
        if: matrix.os == 'macos-latest'
        run: sudo nix develop --command cargo test test_privileged -- --ignored

  windows-build:
    name: Windows Build
    runs-on: ${{ matrix.os }}
    env:
      FORCE_COLOR: 1
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            arch: x64
          - target: aarch64-pc-windows-msvc
            os: windows-11-arm
            arch: arm64
    steps:
      - uses: actions/checkout@v4
      - name: Get Rust version
        id: rust-version
        shell: bash
        run: |
          RUST_VERSION=$(grep "FROM rust" Earthfile | awk -F'[:\\-]' '{print $2}')
          echo "version=${RUST_VERSION}" >> "$GITHUB_OUTPUT"
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ steps.rust-version.outputs.version }}
          targets: ${{ matrix.target }}
          components: clippy, rustfmt

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check code formatting
        run: cargo fmt --check

      - name: Run clippy
        run: >-
          cargo clippy --package lightway-client --target ${{ matrix.target }} -- -D warnings

      - name: Build lightway client
        run: >-
          cargo build --release --bin lightway-client --target ${{ matrix.target }}

      - name: Run tests (${{ matrix.arch }})
        run: cargo test --target ${{ matrix.target }} -p lightway-client

      - name: Upload lightway-client artifact
        uses: actions/upload-artifact@v4
        with:
          name: lightway-client-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/lightway-client.exe

  nightly-release:
    name: Nightly Release
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.ref == 'refs/heads/main'
    concurrency:
      group: nightly-release
      cancel-in-progress: true
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display structure of downloaded artifacts
        run: ls -R artifacts/

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          cp artifacts/lightway-client-x86_64-unknown-linux-gnu/lightway-client release-assets/lightway-client-x86_64-unknown-linux-gnu
          cp artifacts/lightway-server-x86_64-unknown-linux-gnu/lightway-server release-assets/lightway-server-x86_64-unknown-linux-gnu
          cp artifacts/lightway-client-aarch64-unknown-linux-gnu/lightway-client release-assets/lightway-client-aarch64-unknown-linux-gnu
          cp artifacts/lightway-server-aarch64-unknown-linux-gnu/lightway-server release-assets/lightway-server-aarch64-unknown-linux-gnu
          cp artifacts/lightway-client-riscv64gc-unknown-linux-gnu/lightway-client release-assets/lightway-client-riscv64gc-unknown-linux-gnu
          cp artifacts/lightway-server-riscv64gc-unknown-linux-gnu/lightway-server release-assets/lightway-server-riscv64gc-unknown-linux-gnu
          cp artifacts/lightway-client-aarch64-apple-darwin/lightway-client release-assets/lightway-client-aarch64-apple-darwin
          cp artifacts/lightway-server-aarch64-apple-darwin/lightway-server release-assets/lightway-server-aarch64-apple-darwin
          cp artifacts/lightway-client-x86_64-apple-darwin/lightway-client release-assets/lightway-client-x86_64-apple-darwin
          cp artifacts/lightway-server-x86_64-apple-darwin/lightway-server release-assets/lightway-server-x86_64-apple-darwin
          cp artifacts/lightway-client-x86_64-pc-windows-msvc/lightway-client.exe release-assets/lightway-client-x86_64-pc-windows-msvc.exe
          cp artifacts/lightway-client-aarch64-pc-windows-msvc/lightway-client.exe release-assets/lightway-client-aarch64-pc-windows-msvc.exe

          chmod +x release-assets/*

      - name: Create nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: lightway-nightly
          name: Nightly Build
          prerelease: true
          body: |
            Automated nightly build from commit ${{ github.sha }}

            Build date: ${{ github.event.head_commit.timestamp }}

            ## Artifacts
            This release includes pre-built binaries for:
            - **Linux** (x86_64, aarch64, riscv64): lightway-client and lightway-server
            - **macOS** (x86_64, aarch64): lightway-client and lightway-server
            - **Windows** (x86_64, aarch64): lightway-client only
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
